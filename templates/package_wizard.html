{% extends 'base.html' %}

{% block title %}مساعد اختيار الباقة{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="mb-4">
        <nav aria-label="breadcrumb" dir="rtl">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/"><i class="fas fa-home"></i></a></li>
                <li class="breadcrumb-item"><a href="#">مسبق الدفع</a></li>
                <li class="breadcrumb-item active" aria-current="page">مساعد اختيار الباقة</li>
            </ol>
        </nav>
    </div>

    <div class="text-center mb-5">
        <h1 class="mb-3">مساعد اختيار الباقة</h1>
        <h4 class="text-muted">ساعدنا لنساعدك في اختيار أفضل باقة تناسب احتياجاتك</h4>
    </div>

    <!-- Wizard Steps -->
    <div class="wizard-progress mb-5">
        <div class="progress" style="height: 5px;">
            <div class="progress-bar bg-danger" role="progressbar" style="width: 33%;" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100" id="wizard-progress-bar"></div>
        </div>
        <div class="d-flex justify-content-between mt-2">
            <span class="wizard-step active" id="step-1-indicator">١. احتياجاتك</span>
            <span class="wizard-step" id="step-2-indicator">٢. المتطلبات</span>
            <span class="wizard-step" id="step-3-indicator">٣. النتائج</span>
        </div>
    </div>

    <!-- Step 1: Usage Type -->
    <div class="wizard-step-content shadow-sm rounded p-4 bg-white" id="step-1">
        <h3 class="text-center mb-4">ما هو نوع استخدامك الأساسي؟</h3>
        <div class="row justify-content-center text-center">
            <div class="col-md-4 mb-4">
                <div class="usage-type-card p-4 rounded shadow-sm border h-100" data-type="data">
                    <div class="usage-icon mb-3">
                        <i class="fas fa-wifi fa-3x text-primary"></i>
                    </div>
                    <h4>بيانات الإنترنت</h4>
                    <p class="text-muted">أستخدم هاتفي بشكل أساسي لتصفح الإنترنت، التطبيقات والوسائط الاجتماعية</p>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="usage-type-card p-4 rounded shadow-sm border h-100" data-type="voice">
                    <div class="usage-icon mb-3">
                        <i class="fas fa-phone-alt fa-3x text-success"></i>
                    </div>
                    <h4>المكالمات الصوتية</h4>
                    <p class="text-muted">أستخدم هاتفي بشكل أساسي للمكالمات والرسائل النصية</p>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="usage-type-card p-4 rounded shadow-sm border h-100" data-type="combo">
                    <div class="usage-icon mb-3">
                        <i class="fas fa-mobile-alt fa-3x text-danger"></i>
                    </div>
                    <h4>استخدام متوازن</h4>
                    <p class="text-muted">أستخدم هاتفي بشكل متساوٍ للإنترنت والمكالمات</p>
                </div>
            </div>
        </div>
        <div class="mt-4 text-center">
            <button class="btn btn-lg btn-outline-secondary me-2" onclick="window.location.href='/'">إلغاء</button>
            <button class="btn btn-lg btn-danger" id="step-1-next" disabled>التالي <i class="fas fa-arrow-left"></i></button>
        </div>
    </div>

    <!-- Step 2: Specific Requirements -->
    <div class="wizard-step-content shadow-sm rounded p-4 bg-white d-none" id="step-2">
        <h3 class="text-center mb-4">ما هي متطلباتك؟</h3>
        
        <form id="requirements-form">
            <div class="row">
                <div class="col-md-6 mb-4" id="data-requirement-section">
                    <div class="form-group">
                        <label for="data-usage" class="form-label fw-bold mb-2">حجم بيانات الانترنت الشهري</label>
                        <div class="range-container px-2">
                            <input type="range" class="form-range" id="data-usage" min="0" max="40" step="1" value="5">
                            <div class="d-flex justify-content-between">
                                <span>١ غيغابايت</span>
                                <span id="data-usage-value">5 غيغابايت</span>
                                <span>٤٠ غيغابايت</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4" id="voice-requirement-section">
                    <div class="form-group">
                        <label for="voice-usage" class="form-label fw-bold mb-2">عدد دقائق المكالمات الشهرية</label>
                        <div class="range-container px-2">
                            <input type="range" class="form-range" id="voice-usage" min="0" max="2000" step="50" value="200">
                            <div class="d-flex justify-content-between">
                                <span>٠ دقيقة</span>
                                <span id="voice-usage-value">200 دقيقة</span>
                                <span>٢٠٠٠ دقيقة</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="form-group">
                        <label for="budget" class="form-label fw-bold mb-2">الميزانية الشهرية</label>
                        <div class="range-container px-2">
                            <input type="range" class="form-range" id="budget" min="0" max="250" step="10" value="100">
                            <div class="d-flex justify-content-between">
                                <span>١٠ ر.ق</span>
                                <span id="budget-value">100 ر.ق</span>
                                <span>٢٥٠ ر.ق</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        
        <div class="mt-4 text-center">
            <button class="btn btn-lg btn-outline-secondary me-2" id="step-2-prev"><i class="fas fa-arrow-right"></i> السابق</button>
            <button class="btn btn-lg btn-danger" id="step-2-next">التالي <i class="fas fa-arrow-left"></i></button>
        </div>
    </div>

    <!-- Step 3: Recommendations -->
    <div class="wizard-step-content shadow-sm rounded p-4 bg-white d-none" id="step-3">
        <h3 class="text-center mb-4">الباقات الموصى بها</h3>
        
        <div id="recommendations-container" class="row">
            <!-- Results will be populated here via JavaScript -->
            <div class="text-center py-5">
                <div class="spinner-border text-danger" role="status">
                    <span class="visually-hidden">جاري التحميل...</span>
                </div>
                <p class="mt-3">جاري تحليل متطلباتك...</p>
            </div>
        </div>
        
        <div class="mt-4 text-center">
            <button class="btn btn-lg btn-outline-secondary me-2" id="step-3-prev"><i class="fas fa-arrow-right"></i> السابق</button>
            <button class="btn btn-lg btn-danger" id="restart-wizard">ابدأ من جديد</button>
            <a href="/recharge" class="btn btn-lg btn-success">اشتراك في باقة <i class="fas fa-arrow-left"></i></a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Step navigation
        let currentStep = 1;
        let usageType = '';
        
        // Usage type selection
        const usageTypeCards = document.querySelectorAll('.usage-type-card');
        const step1NextBtn = document.getElementById('step-1-next');
        
        usageTypeCards.forEach(card => {
            card.addEventListener('click', function() {
                // Remove active class from all cards
                usageTypeCards.forEach(c => c.classList.remove('active', 'border-danger'));
                
                // Add active class to the clicked card
                this.classList.add('active', 'border-danger');
                
                // Enable next button
                step1NextBtn.removeAttribute('disabled');
                
                // Store the selected usage type
                usageType = this.getAttribute('data-type');
            });
        });
        
        // Range sliders
        const dataUsageSlider = document.getElementById('data-usage');
        const dataUsageValue = document.getElementById('data-usage-value');
        const voiceUsageSlider = document.getElementById('voice-usage');
        const voiceUsageValue = document.getElementById('voice-usage-value');
        const budgetSlider = document.getElementById('budget');
        const budgetValue = document.getElementById('budget-value');
        
        dataUsageSlider.addEventListener('input', function() {
            dataUsageValue.textContent = this.value + ' غيغابايت';
        });
        
        voiceUsageSlider.addEventListener('input', function() {
            voiceUsageValue.textContent = this.value + ' دقيقة';
        });
        
        budgetSlider.addEventListener('input', function() {
            budgetValue.textContent = this.value + ' ر.ق';
        });
        
        // Next button for step 1
        step1NextBtn.addEventListener('click', function() {
            goToStep(2);
            
            // Show/hide relevant sections based on usage type
            if (usageType === 'data') {
                document.getElementById('data-requirement-section').classList.remove('d-none');
                document.getElementById('voice-requirement-section').classList.add('d-none');
            } else if (usageType === 'voice') {
                document.getElementById('data-requirement-section').classList.add('d-none');
                document.getElementById('voice-requirement-section').classList.remove('d-none');
            } else {
                document.getElementById('data-requirement-section').classList.remove('d-none');
                document.getElementById('voice-requirement-section').classList.remove('d-none');
            }
        });
        
        // Previous button for step 2
        document.getElementById('step-2-prev').addEventListener('click', function() {
            goToStep(1);
        });
        
        // Next button for step 2
        document.getElementById('step-2-next').addEventListener('click', function() {
            goToStep(3);
            getRecommendations();
        });
        
        // Previous button for step 3
        document.getElementById('step-3-prev').addEventListener('click', function() {
            goToStep(2);
        });
        
        // Restart wizard button
        document.getElementById('restart-wizard').addEventListener('click', function() {
            goToStep(1);
            // Reset selections
            usageTypeCards.forEach(c => c.classList.remove('active', 'border-danger'));
            step1NextBtn.setAttribute('disabled', 'disabled');
            dataUsageSlider.value = 5;
            dataUsageValue.textContent = '5 غيغابايت';
            voiceUsageSlider.value = 200;
            voiceUsageValue.textContent = '200 دقيقة';
            budgetSlider.value = 100;
            budgetValue.textContent = '100 ر.ق';
        });
        
        // Function to navigate between steps
        function goToStep(step) {
            // Hide all steps
            document.querySelectorAll('.wizard-step-content').forEach(el => {
                el.classList.add('d-none');
            });
            
            // Show the current step
            document.getElementById('step-' + step).classList.remove('d-none');
            
            // Update progress bar
            const progressBar = document.getElementById('wizard-progress-bar');
            progressBar.style.width = (step * 33.33) + '%';
            progressBar.setAttribute('aria-valuenow', step * 33.33);
            
            // Update step indicators
            document.querySelectorAll('.wizard-step').forEach((indicator, index) => {
                if (index + 1 <= step) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
            
            currentStep = step;
        }
        
        // Function to get package recommendations
        function getRecommendations() {
            const recommendationsContainer = document.getElementById('recommendations-container');
            recommendationsContainer.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                    <p class="mt-3">جاري تحليل متطلباتك...</p>
                </div>
            `;
            
            // Get values from form
            const dataUsage = usageType === 'voice' ? 0 : parseInt(dataUsageSlider.value);
            const voiceUsage = usageType === 'data' ? 0 : parseInt(voiceUsageSlider.value);
            const budget = parseInt(budgetSlider.value);
            
            // Call API to get recommendations
            fetch(`/api/package-recommendations?data_usage=${dataUsage}&voice_usage=${voiceUsage}&budget=${budget}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        recommendationsContainer.innerHTML = `
                            <div class="col-12 text-center py-5">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                    <h4>لم نتمكن من إيجاد باقات مناسبة</h4>
                                    <p>حاول تعديل متطلباتك أو زيادة ميزانيتك</p>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    // Clear container
                    recommendationsContainer.innerHTML = '';
                    
                    // Create recommendation cards
                    data.forEach((package, index) => {
                        const card = document.createElement('div');
                        card.className = 'col-lg-4 col-md-6 mb-4';
                        
                        card.innerHTML = `
                            <div class="card h-100 ${index === 0 ? 'border-danger' : ''} recommendation-card">
                                <div class="card-header bg-${index === 0 ? 'danger' : 'light'} text-${index === 0 ? 'white' : 'dark'}">
                                    ${index === 0 ? '<span class="badge bg-warning text-dark">الأنسب لك</span>' : ''}
                                    <h4 class="my-2">${package.name_ar}</h4>
                                </div>
                                <div class="card-body">
                                    <h3 class="price-tag mb-3">
                                        <span class="currency">ر.ق</span>
                                        <span class="price">${package.price}</span>
                                        <span class="period">/شهر</span>
                                    </h3>
                                    
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><i class="fas fa-wifi text-primary me-2"></i> ${package.data_allowance_gb} غيغابايت من البيانات</li>
                                        <li class="mb-2"><i class="fas fa-phone-alt text-success me-2"></i> ${package.voice_minutes} دقيقة محلية</li>
                                        <li class="mb-2"><i class="fas fa-calendar-alt text-info me-2"></i> صلاحية ${package.validity_days} يوم</li>
                                    </ul>
                                    
                                    <p class="text-muted small">${package.description_ar}</p>
                                </div>
                                <div class="card-footer text-center">
                                    <form method="POST" action="/recharge-payment">
                                        <input type="hidden" name="mobile_number" value="">
                                        <input type="hidden" name="package" value="${package.id}">
                                        <button type="button" class="btn btn-lg ${index === 0 ? 'btn-danger' : 'btn-outline-danger'} select-package" data-package-id="${package.id}">
                                            اختر هذه الباقة
                                        </button>
                                    </form>
                                </div>
                            </div>
                        `;
                        
                        recommendationsContainer.appendChild(card);
                    });
                    
                    // Add event listeners to select package buttons
                    document.querySelectorAll('.select-package').forEach(button => {
                        button.addEventListener('click', function() {
                            const packageId = this.getAttribute('data-package-id');
                            window.location.href = `/recharge?recommended_package=${packageId}`;
                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching recommendations:', error);
                    recommendationsContainer.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                                <h4>حدث خطأ أثناء جلب التوصيات</h4>
                                <p>يرجى المحاولة مرة أخرى لاحقًا</p>
                            </div>
                        </div>
                    `;
                });
        }
    });
</script>

<style>
    .wizard-step {
        color: #6c757d;
        font-weight: 500;
    }
    
    .wizard-step.active {
        color: #e60000;
        font-weight: 700;
    }
    
    .usage-type-card {
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid #dee2e6;
    }
    
    .usage-type-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .usage-type-card.active {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        border-color: #e60000 !important;
    }
    
    .price {
        font-size: 2.5rem;
        color: #e60000;
        font-weight: 700;
    }
    
    .currency {
        font-size: 1rem;
        vertical-align: super;
    }
    
    .period {
        font-size: 1rem;
        color: #6c757d;
    }
    
    .recommendation-card {
        transition: all 0.3s;
    }
    
    .recommendation-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    /* Range slider styling */
    .form-range::-webkit-slider-thumb {
        background: #e60000;
    }
    
    .form-range::-moz-range-thumb {
        background: #e60000;
    }
    
    .form-range::-ms-thumb {
        background: #e60000;
    }
</style>
{% endblock %}